<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kedai Libur</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #F3C6E6;
      min-height: 100vh;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }
    .center-img {
      width: calc(100vw - 40px);
      max-width: 900px;
      display: block;
      margin: 40px auto 0 auto;
      animation: pulse 2s infinite;
      box-shadow: 0 0 32px 0 rgba(243, 198, 230, 0.5);
      border-radius: 24px;
      transition: box-shadow 0.3s;
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 0 32px 0 rgba(243, 198, 230, 0.5);}
      50% { transform: scale(1.05); box-shadow: 0 0 48px 4px rgba(243, 198, 230, 0.8);}
      100% { transform: scale(1); box-shadow: 0 0 32px 0 rgba(243, 198, 230, 0.5);}
    }
    audio { display: none; }
    .game-container {
      width: calc(100vw - 40px);
      max-width: 600px;
      margin: 30px auto 0 auto;
      border-radius: 16px;
      box-shadow: none;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .game-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: #8d35a7;
      margin-bottom: 10px;
      letter-spacing: 1px;
      text-align: center;
      background: none;
    }
    canvas {
      background: #F3C6E6;
      border-radius: 8px;
      display: block;
      margin: 0 auto;
      box-shadow: 0 2px 10px rgba(243, 198, 230, 0.2);
      width: 100%;
      height: 120px;
      max-width: 560px;
    }
    .game-info {
      margin-top: 10px;
      font-size: 1rem;
      color: #8d35a7;
      text-align: center;
      background: none;
    }
    #popup-score {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      background: rgba(243,198,230,0.92);
    }
    #popup-score-content {
      background: #fff;
      color: #d2226d;
      font-weight: bold;
      font-size: 2.5rem;
      padding: 36px 36px 24px 36px;
      border-radius: 32px;
      box-shadow: 0 0 44px 0 rgba(141,53,167,0.22);
      text-align: center;
      min-width: 240px;
      max-width: 80vw;
      letter-spacing: 2px;
      position: relative;
      animation: popin 0.7s cubic-bezier(.68,-0.55,.27,1.55);
      overflow: visible;
    }
    @keyframes popin {
      0% {
        transform: scale(0.6) rotate(-10deg);
        opacity: 0;
        box-shadow: 0 0 0 0 rgba(141,53,167,0.05);
      }
      60% {
        transform: scale(1.08) rotate(7deg);
        opacity: 1;
      }
      85% {
        transform: scale(0.97) rotate(-3deg);
      }
      100% {
        transform: scale(1) rotate(0);
        box-shadow: 0 0 44px 0 rgba(141,53,167,0.22);
      }
    }
    #popup-close {
      position: absolute;
      top: 18px;
      right: 22px;
      font-size: 2rem;
      color: #d2226d;
      background: none;
      border: none;
      cursor: pointer;
      font-weight: bold;
      z-index: 1;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      outline: none;
    }
    #popup-close:active,
    #popup-close:focus {
      background: #f3c6e6;
    }
    #popup-close:hover {
      color: #8d35a7;
    }
    #popup-score-content .skor-value {
      color: #8d35a7;
      font-size: 2.8rem;
      display: block;
      margin: 18px auto 0 auto;
      font-weight: bold;
    }
    #popup-score-content .popup-info {
      color: #8d35a7;
      font-size: 1.2rem;
      margin-top: 16px;
      font-weight: normal;
      display: block;
    }
    .hadiah-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(90deg, #F9D423 0%, #FF4E50 100%);
      color: #fff;
      font-size: 1.15rem;
      font-weight: bold;
      border-radius: 28px;
      padding: 10px 30px;
      margin: 18px 8px 0 8px;
      box-shadow: 0 3px 18px 0 rgba(255, 78, 80, 0.11), 0 0 18px 0 #ffe5a2;
      border: 2.5px solid #fff7ad;
      letter-spacing: 1px;
      position: relative;
      animation: badgepop 0.8s cubic-bezier(.68,-0.55,.27,1.55);
      text-shadow: 0 2px 8px #ffadad, 0 1px 0 #c972a9;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .hadiah-badge:hover {
      transform: scale(1.13) rotate(-2deg);
      background: linear-gradient(90deg, #FF4E50 0%, #F9D423 100%);
    }
    @keyframes badgepop {
      0% { transform: scale(0.2) rotate(-13deg); opacity:0; }
      60% { transform: scale(1.14) rotate(9deg); opacity: 1;}
      90% { transform: scale(0.93) rotate(-4deg);}
      100% { transform: scale(1) rotate(0);}
    }
    .confetti {
      pointer-events: none;
      position: absolute;
      left: 50%;
      top: 0;
      width: 1px;
      height: 1px;
      z-index: 10000;
    }
    .hadiah-utama-effect {
      border: 3.5px solid #F9D423;
      box-shadow: 0 0 44px 0 #ffe5a2, 0 0 88px 0 #F9D423;
      animation: utamaPulse 1.2s infinite alternate cubic-bezier(.68,-0.55,.27,1.55);
      background: linear-gradient(90deg, #F9D423 15%, #FF4E50 85%);
      color: #fff !important;
      font-size: 1.3rem;
    }
    @keyframes utamaPulse {
      0% { box-shadow: 0 0 44px 0 #ffe5a2, 0 0 88px 0 #F9D423; }
      100% { box-shadow: 0 0 80px 6px #ffe5a2, 0 0 144px 9px #F9D423; }
    }
    .hadiah-utama-label {
      color: #ff4e50;
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 12px;
      display: inline-block;
      letter-spacing: 1px;
      background: #fff7ad;
      padding: 6px 26px;
      border-radius: 18px;
      box-shadow: 0 1px 8px 0 #ffe5a2;
      animation: utamaLabelPop 0.7s;
    }
    @keyframes utamaLabelPop {
      0% { transform: scale(0.3) rotate(-10deg); opacity: 0;}
      65% { transform: scale(1.12) rotate(10deg); opacity:1;}
      100% { transform: scale(1) rotate(0);}
    }
    /* Tombol screenshot */
    #btn-screenshot {
      display: none;
      margin-top: 28px;
      background: linear-gradient(90deg,#25D366 0%, #128C7E 100%);
      color: #fff;
      border: none;
      border-radius: 22px;
      padding: 13px 36px;
      font-size: 1.18rem;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 2px 20px 0 #25d36655, 0 2px 8px #128C7E22;
      cursor: pointer;
      outline: none;
      transition: background 0.2s, transform 0.15s;
      position: relative;
      z-index: 10;
    }
    #btn-screenshot:hover, #btn-screenshot:focus {
      background: linear-gradient(90deg,#128C7E 0%, #25D366 100%);
      transform: scale(1.06);
    }
    #btn-screenshot.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    #btn-screenshot .loader {
      display: inline-block;
      width: 22px;
      height: 22px;
      border: 3px solid #fff;
      border-top: 3px solid #25D366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% {transform: rotate(0deg);}
      100% {transform: rotate(360deg);}
    }
  </style>
  <!-- html2canvas for screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <img src="libur.webp" alt="Libur Harinfood" class="center-img">
  <audio id="musik-libur" src="libur.mp3" loop></audio>
  <audio id="suara-aduh" src="aduh.mp3"></audio>
  <div class="game-container">
    <div class="game-title">Permainan menuju ke HARINFOOD</div>
    <canvas id="dino-game" width="560" height="120"></canvas>
    <div class="game-info" id="game-info">Sentuh layar atau klik/tap di area ini untuk mulai!</div>
  </div>
  <div id="popup-score">
    <div id="popup-score-content">
      <button id="popup-close" title="Tutup" tabindex="0">&times;</button>
      <span>GAME OVER!</span>
      <span class="skor-value" id="skor-value">0</span>
      <div id="hadiah-container"></div>
      <button id="btn-screenshot"><span class="wa-ico">ðŸ“¸</span> Bagikan ke WhatsApp</button>
      <span class="popup-info">Tekan tombol &times; untuk mulai ulang</span>
    </div>
  </div>
  <script>
    // GANTI API KEY INI DENGAN PUNYA ANDA DARI https://imgbb.com/
    const imgbbApiKey = "ae2e569fd7df4ad7df2c151190650ecc"; // <-- GANTI API KEY ANDA DI SINI

    // Responsive canvas
    const canvas = document.getElementById('dino-game');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() {
      const deviceWidth = Math.min(window.innerWidth - 40, 560);
      canvas.width = deviceWidth;
      canvas.height = 120;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Load harinfood image
    const harinfoodImg = new Image();
    harinfoodImg.src = 'harinfood.webp';

    // Dino properties
    let dino = {
      x: 50, y: 80, width: 36, height: 36,
      vy: 0, gravity: 1.25, jump: -11,
      isJumping: false
    };

    // Obstacles
    let obstacles = [];
    let obstacleInterval = 0;
    let score = 0;
    let gameOver = false;
    let speed = 3.2;
    let gameStarted = false;

    // Musik & suara
    const audio = document.getElementById('musik-libur');
    const suaraAduh = document.getElementById('suara-aduh');
    let musikHasPlayed = false;

    // Pop up skor
    const popupScore = document.getElementById('popup-score');
    const skorValue = document.getElementById('skor-value');
    const popupClose = document.getElementById('popup-close');
    const hadiahContainer = document.getElementById('hadiah-container');
    const btnScreenshot = document.getElementById('btn-screenshot');

    // Confetti effect
    function showConfetti() {
      for (let i = 0; i < 36; i++) {
        createConfetti();
      }
      setTimeout(() => {
        document.querySelectorAll('.confetti').forEach(e => e.remove());
      }, 1800);
    }
    function createConfetti() {
      const confettiColors = ['#F9D423','#FF4E50','#8d35a7','#34a853','#F3C6E6','#fff7ad','#ffadad','#c972a9'];
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.left = (50 + (Math.random() * 60 - 30)) + '%';
      el.style.top = (10 + Math.random() * 10) + '%';
      el.style.width = el.style.height = (10 + Math.random()*10) + 'px';
      el.style.background = confettiColors[Math.floor(Math.random()*confettiColors.length)];
      el.style.borderRadius = Math.random() > 0.5 ? '50%' : '3px';
      el.style.opacity = 0.65 + Math.random()*0.35;
      el.style.position = 'absolute';
      el.style.zIndex = 10000;
      el.style.transform = `rotate(${Math.random()*360}deg)`;
      el.style.transition = 'transform 1.1s cubic-bezier(.19,1,.22,1), top 1.2s cubic-bezier(.19,1,.22,1), opacity 1.2s';
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.top = (80 + Math.random()*10) + '%';
        el.style.transform = `translateY(${80 + Math.random()*20}px) rotate(${Math.random()*720}deg) scale(${0.8+Math.random()*0.7})`;
        el.style.opacity = 0;
      }, 20);
    }

    function playMusicOnce() {
      if (!musikHasPlayed) {
        audio.currentTime = 0;
        audio.volume = 1;
        audio.play().then(() => {
          musikHasPlayed = true;
        }).catch(() => {
          // Jika gagal, tetap akan dicoba lagi pada tap berikutnya
        });
      }
    }

    function stopMusic() {
      audio.pause();
      audio.currentTime = 0;
    }
    function playAduh() {
      suaraAduh.currentTime = 0;
      suaraAduh.play();
    }
    function stopAduh() {
      suaraAduh.pause();
      suaraAduh.currentTime = 0;
    }

    function drawDino() {
      if (harinfoodImg.complete && harinfoodImg.naturalWidth !== 0) {
        ctx.drawImage(harinfoodImg, dino.x, dino.y, dino.width, dino.height);
      } else {
        ctx.save();
        ctx.fillStyle = "#34a853";
        ctx.fillRect(dino.x, dino.y, dino.width, dino.height);
        ctx.restore();
      }
    }

    function drawObstacle(obs) {
      ctx.save();
      ctx.fillStyle = "#c972a9";
      ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
      ctx.restore();
    }

    function drawScore() {
      ctx.save();
      ctx.font = "bold 18px Arial";
      ctx.fillStyle = "#8d35a7";
      ctx.fillText("Skor: " + score, canvas.width - 120, 30);
      ctx.restore();
    }

    function drawStartScreen() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.font = "bold 22px Arial";
      ctx.fillStyle = "#8d35a7";
      ctx.textAlign = "center";
      ctx.fillText("Sentuh layar atau klik/tap untuk mulai!", canvas.width / 2, 70);
      ctx.restore();
      drawDino();
    }

    function showHadiahAnim(hadiahObj) {
      hadiahContainer.innerHTML = '';
      if (!hadiahObj.nameArr.length) {
        hadiahContainer.style.display = 'none';
        btnScreenshot.style.display = 'none';
        return;
      }
      hadiahContainer.style.display = 'block';
      if(hadiahObj.utama){
        hadiahContainer.innerHTML += `<div class="hadiah-utama-label">ðŸŽ‰ HADIAH UTAMA ðŸŽ‰</div>`;
      }
      hadiahObj.nameArr.forEach(h => {
        let emoji = '';
        if (h.toLowerCase().includes('cibay')) emoji = 'ðŸŒ¯';
        if (h.toLowerCase().includes('risol')) emoji = 'ðŸ¥Ÿ';
        hadiahContainer.innerHTML += `<span class="hadiah-badge${hadiahObj.utama?' hadiah-utama-effect':''}" title="Selamat!">${emoji} ${h.toUpperCase()}</span>`;
      });
      btnScreenshot.style.display = 'inline-block';
    }

    function resetGame() {
      dino.y = 80;
      dino.vy = 0;
      obstacles = [];
      obstacleInterval = 0;
      score = 0;
      gameOver = false;
      popupScore.style.display = "none";
      hadiahContainer.innerHTML = '';
      hadiahContainer.style.display = 'none';
      btnScreenshot.style.display = 'none';
      document.getElementById("game-info").textContent = "Sentuh layar di mana saja untuk meloncat!";
      // Hentikan aduh, mainkan musik libur lagi
      stopAduh();
      audio.currentTime = 0;
      audio.play().then(() => {
        musikHasPlayed = true;
      }).catch(() => {});
      loop();
    }

    function showPopupSkor() {
      skorValue.innerText = score;
      popupScore.style.display = "flex";
      popupClose.focus();
      // Hentikan musik libur, mainkan suara aduh
      stopMusic();
      playAduh();

      // Hadiah dan animasi
      let hadiahObj = { nameArr: [], utama: false };
      // Hadiah dengan prioritas:
      // 1. Skor >= 1000: risol 1 + cibay 1 (hadiah utama)
      // 2. Skor >= 700: risol
      // 3. Skor >= 500: cibay 1
      if (score >= 1000) {
        hadiahObj = { nameArr: ['Risol 1', 'Cibay 1'], utama: true };
      } else if (score >= 700) {
        hadiahObj = { nameArr: ['Risol'], utama: false };
      } else if (score >= 500) {
        hadiahObj = { nameArr: ['Cibay 1'], utama: false };
      }
      showHadiahAnim(hadiahObj);
      if (hadiahObj.nameArr.length) showConfetti();
      else btnScreenshot.style.display = 'none';
    }

    function loop() {
      if (!gameStarted) {
        drawStartScreen();
        return;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (gameOver) {
        showPopupSkor();
        return;
      }
      drawDino();
      drawScore();
      dino.y += dino.vy;
      if (dino.y >= 80) {
        dino.y = 80;
        dino.vy = 0;
        dino.isJumping = false;
      } else {
        dino.vy += dino.gravity;
      }
      obstacleInterval++;
      if (obstacleInterval > (70 + Math.max(0, 200 - score * 2))) {
        obstacleInterval = 0;
        const height = 24 + Math.random() * 16;
        obstacles.push({ x: canvas.width, y: 120 - height, width: 15 + Math.random()*8, height: height });
      }
      for (let i = 0; i < obstacles.length; i++) {
        obstacles[i].x -= speed + Math.min(score/30, 3);
        drawObstacle(obstacles[i]);
        if (
          dino.x + dino.width > obstacles[i].x &&
          dino.x < obstacles[i].x + obstacles[i].width &&
          dino.y + dino.height > obstacles[i].y
        ) {
          gameOver = true;
        }
      }
      obstacles = obstacles.filter(o => o.x + o.width > 0);
      score++;
      requestAnimationFrame(loop);
    }

    function startGameAndMusic() {
      playMusicOnce();
      if (!gameStarted) {
        gameStarted = true;
        document.getElementById("game-info").textContent = "Sentuh layar di mana saja untuk meloncat!";
        loop();
      }
    }

    function lompat() {
      if (!gameStarted) return;
      if (!musikHasPlayed) playMusicOnce();
      if (!dino.isJumping && !gameOver) {
        dino.vy = dino.jump;
        dino.isJumping = true;
      }
    }

    document.addEventListener('keydown', function(e) {
      if (!gameStarted && (e.code === "Space" || e.code === "Enter")) {
        startGameAndMusic();
      } else if (gameStarted && !gameOver) {
        if (e.code === "Space") lompat();
      } else if (gameOver && (e.code === "Enter" || e.code === "Space")) {
        resetGame();
      }
    });

    function globalTap(e) {
      if (!gameStarted) {
        startGameAndMusic();
      } else if (!gameOver) {
        lompat();
      }
      e.preventDefault();
    }
    document.body.addEventListener('touchstart', globalTap, { passive: false });
    document.body.addEventListener('mousedown', globalTap);

    // Tombol close (X) di pop up
    popupClose.addEventListener('click', function(e){
      resetGame();
      e.preventDefault();
      e.stopPropagation();
    });
    popupClose.addEventListener('touchstart', function(e){
      resetGame();
      e.preventDefault();
      e.stopPropagation();
    }, { passive: false });

    // Prevent close pop up dengan tap di luar tombol X
    popupScore.addEventListener('touchstart', function(e){
      if (e.target !== popupClose) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, { passive: false });
    popupScore.addEventListener('mousedown', function(e){
      if (e.target !== popupClose) {
        e.preventDefault();
        e.stopPropagation();
      }
    });

    harinfoodImg.onload = function() {
      loop();
    };
    loop();

    // SCREENSHOT + SHARE WA
    btnScreenshot.addEventListener('click', async function(){
      if(btnScreenshot.classList.contains('loading')) return;
      btnScreenshot.classList.add('loading');
      btnScreenshot.innerHTML = `<span class="loader"></span> Sedang membuat gambar...`;
      try{
        const popupContent = document.getElementById('popup-score-content');
        const canvas = await html2canvas(popupContent, {
          backgroundColor: null,
          logging: false,
          scale: 2,
          useCORS: true
        });
        const dataUrl = canvas.toDataURL('image/png');
        // Upload ke imgbb
        if(imgbbApiKey === "YOUR_IMGBB_API_KEY"){
          alert("Anda belum mengisi API Key imgbb.com!\nSilakan daftar gratis di imgbb.com lalu copy apikey ke kode HTML.");
          btnScreenshot.classList.remove('loading');
          btnScreenshot.innerHTML = `<span class="wa-ico">ðŸ“¸</span> Bagikan ke WhatsApp`;
          return;
        }
        const blob = await (await fetch(dataUrl)).blob();
        const formData = new FormData();
        formData.append('image', await blobToBase64(blob));
        formData.append('key', imgbbApiKey);

        const upload = await fetch('https://api.imgbb.com/1/upload', {
          method:'POST',
          body: formData
        });
        const response = await upload.json();
        if(response && response.data && response.data.url){
          // Share ke WA
          const imgUrl = response.data.url;
          const waText = encodeURIComponent(
            `Yey! Saya dapat hadiah di game Kedai Libur\nSkor: ${skorValue.innerText}\nCek hadiahku: ${imgUrl}`
          );
          window.open(`https://wa.me/6281235368643?text=${waText}`,'_blank');
        }else{
          alert("Upload gambar gagal, coba lagi ya.");
        }
      }catch(err){
        alert("Gagal membuat screenshot atau upload, coba ulangi.\nError: "+err);
      }
      btnScreenshot.classList.remove('loading');
      btnScreenshot.innerHTML = `<span class="wa-ico">ðŸ“¸</span> Bagikan ke WhatsApp`;
    });

    async function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = function() {
          // Format data:image/png;base64,xxx
          const base64data = reader.result.split(',')[1];
          resolve(base64data);
        }
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>